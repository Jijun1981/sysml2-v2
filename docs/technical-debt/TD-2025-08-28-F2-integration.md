# 技术债务记录 - STORY-F2 三视图数据集成

## 文档信息
- **日期**: 2025-08-28
- **任务**: STORY-F2 三视图数据集成修复
- **相关需求**: REQ-F2-1, REQ-F2-2, REQ-F2-3

---

## 技术债务清单

### TD-F2-1: 测试框架兼容性问题
**严重程度**: 高
**影响**: 测试无法正常运行
**描述**: 
- 测试文件混用了Jest和Vitest语法
- Mock服务时出现序列化错误（DataCloneError）
- requirementService的mock方式需要调整

**表现**:
```
DataCloneError: function transformRequest(data, headers) {...} could not be cloned.
```

**建议解决方案**:
1. 统一使用Vitest的mock语法
2. 调整requirementService的mock方式，避免axios实例的序列化问题
3. 考虑使用MSW（Mock Service Worker）进行API mock

---

### TD-F2-2: 组件与测试的耦合问题
**严重程度**: 中
**影响**: 测试脆弱，维护成本高
**描述**:
- TreeView和TableView组件直接依赖requirementService
- 测试时需要mock整个服务层
- 组件内部状态管理复杂

**建议解决方案**:
1. 引入依赖注入模式，让服务可以作为props传入
2. 分离数据获取逻辑到独立的hooks
3. 使用Context更好地管理数据流

---

### TD-F2-3: 字段映射不一致
**严重程度**: 中
**影响**: 数据显示可能不正确
**描述**:
- 后端返回的数据结构与前端期望的不完全一致
- requirementDefinition字段在不同组件中处理方式不同
- Definition ID到名称的映射逻辑分散在多个组件

**建议解决方案**:
1. 创建统一的数据转换层
2. 定义清晰的DTO接口
3. 集中管理字段映射逻辑

---

### TD-F2-4: 性能问题
**严重程度**: 低
**影响**: 大数据量时可能卡顿
**描述**:
- 没有实现虚拟滚动
- 数据过滤在前端进行，没有利用后端分页
- 每次更新都重新获取所有数据

**建议解决方案**:
1. 实现虚拟滚动（TreeView已有配置但未启用）
2. 将过滤逻辑移到后端
3. 实现增量数据更新

---

### TD-F2-5: 错误处理不完善
**严重程度**: 低
**影响**: 用户体验不佳
**描述**:
- 加载失败时只显示简单错误信息
- 没有重试机制
- 网络错误和业务错误没有区分

**建议解决方案**:
1. 实现详细的错误分类和处理
2. 添加自动重试机制
3. 提供更友好的错误提示

---

## 已完成但需要改进的部分

### 完成的功能
1. ✅ TreeView从requirementService加载真实数据
2. ✅ TableView支持标准化字段显示
3. ✅ Usage-Definition关联显示
4. ✅ 基本的搜索和过滤功能

### 需要改进的方面
1. ⚠️ 测试覆盖率不足（17个测试中9个失败）
2. ⚠️ 缺少端到端集成测试
3. ⚠️ 图视图（REQ-F2-3）尚未实现
4. ⚠️ 三视图联动机制需要加强

---

## 优先级建议

### P0 - 紧急修复
1. 修复测试框架兼容性问题（TD-F2-1）
2. 确保所有测试通过

### P1 - 短期改进
1. 解决字段映射不一致问题（TD-F2-3）
2. 完善错误处理（TD-F2-5）

### P2 - 长期优化
1. 重构组件架构，降低耦合（TD-F2-2）
2. 性能优化（TD-F2-4）

---

## 影响分析

### 对Phase 1的影响
- 测试问题会阻塞CI/CD流程
- 字段映射问题可能导致数据显示错误
- 性能问题在数据量增大后会更明显

### 风险评估
- **高风险**: 测试框架问题需要立即解决
- **中风险**: 字段映射需要在Phase 1前统一
- **低风险**: 性能问题可以后续迭代优化

---

## 行动计划

### 立即行动
1. 修复测试文件的mock问题
2. 运行完整测试套件，确保回归测试通过
3. 更新测试文档，说明正确的mock方式

### 下一步
1. 实现REQ-F2-3（图视图关系显示）
2. 创建端到端集成测试
3. 重构数据获取逻辑到hooks

### 长期规划
1. 建立组件库和设计系统
2. 实施性能监控
3. 完善错误追踪机制