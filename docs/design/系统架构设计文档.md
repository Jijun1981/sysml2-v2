# SysML v2 建模平台系统架构设计文档

## 1. 引言

### 1.1 文档目的
本文档描述SysML v2建模平台的系统架构设计，为开发团队提供技术实现指导。

### 1.2 文档范围
- 系统整体架构设计
- 技术选型与依据
- 核心组件设计
- 数据流转机制
- 部署架构

### 1.3 术语定义
- **SysML v2**: Systems Modeling Language Version 2，OMG标准建模语言
- **EMF**: Eclipse Modeling Framework，模型驱动开发框架
- **M2层**: 元模型层，定义模型的结构（如RequirementDefinition类型）
- **M1层**: 模型实例层，具体的模型对象（如"电池容量需求"实例）

---

## 2. 系统概述

### 2.1 系统定位
SysML v2建模平台是一个基于Web的系统工程建模工具，支持需求管理、系统设计和模型追溯。

### 2.2 系统目标
- 提供符合OMG SysML v2标准的建模能力
- 支持需求定义、使用和追溯关系管理
- 提供多视图（树、表、图）的模型展示
- 实现模型的持久化存储和版本管理

### 2.3 设计原则
- **标准兼容**: 完全兼容SysML v2 Pilot Implementation
- **架构清晰**: 采用分层架构，职责分离
- **技术收敛**: 选用成熟技术栈，避免技术风险
- **扩展性**: 预留扩展点，支持未来功能增强

---

## 3. 总体架构

### 3.1 架构视图

#### 3.1.1 逻辑架构

```
┌─────────────────────────────────────────────────────────┐
│                    展示层 (Presentation Layer)          │
│                         Web Browser                     │
└─────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)           │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────┐  │
│  │            控制层 (Controller Layer)              │  │
│  │         RESTful API / HTTP Endpoint              │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │            领域层 (Domain Layer)                  │  │
│  │  RequirementService | PartService | ...          │  │
│  │  • 业务逻辑实现                                   │  │
│  │  • 业务规则验证                                   │  │
│  │  • 视图数据编排                                   │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │      EMF工具层 (EMF Utilities Layer)             │  │
│  │         UniversalElementService                  │  │
│  │  • EMF模型的CRUD操作封装                         │  │
│  │  • 仅供领域层内部调用                             │  │
│  │  • Controller不可直接访问                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────┐
│                    模型层 (Model Layer)                 │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────┐  │
│  │          EMF模型框架 (EMF Framework)              │  │
│  │  • SysML元模型 (M2): 182个EClass定义             │  │
│  │  • 模型实例 (M1): RequirementDefinition等对象    │  │
│  │  • 模型操作: EObject CRUD, 查询, 验证            │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────┐
│                  持久化层 (Persistence Layer)           │
│        FileModelRepository | EMF Resource管理           │
└─────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────┐
│                  存储层 (Storage Layer)                 │
│                    JSON File System                     │
└─────────────────────────────────────────────────────────┘
```

#### 3.1.2 物理架构

```
┌──────────────────┐         ┌──────────────────┐
│   Client Browser │ ←────→  │   Web Server     │
│   (React SPA)    │  HTTP   │  (Spring Boot)   │
└──────────────────┘         └──────────────────┘
                                      ↓
                             ┌──────────────────┐
                             │   File System    │
                             │  (JSON Storage)  │
                             └──────────────────┘
```

### 3.2 架构分层说明

| 层次 | 职责 | 主要组件 |
|------|------|----------|
| **展示层** | 用户界面展示与交互 | React组件、视图管理 |
| **控制层** | HTTP请求处理、路由分发 | Spring MVC Controller |
| **领域层** | 业务逻辑实现、业务规则验证、视图编排 | RequirementService等Domain Service |
| **EMF工具层** | EMF模型CRUD操作封装（不含业务逻辑） | UniversalElementService |
| **模型层** | 模型定义、实例管理、模型操作 | EMF Framework、SysML Metamodel |
| **持久化层** | 资源管理、序列化 | Repository、EMF Resource |
| **存储层** | 物理存储 | 文件系统 |

---

## 4. 技术架构

### 4.1 技术栈

#### 4.1.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI框架 |
| TypeScript | 5.x | 类型安全 |
| React Flow | 11.x | 图形化展示 |
| Ant Design | 5.x | UI组件库 |
| Vite | 5.x | 构建工具 |

#### 4.1.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Java | 17 | 开发语言 |
| Spring Boot | 3.2 | 应用框架 |
| Spring MVC | 6.x | Web层框架 |
| EMF | 2.35 | 模型框架 |
| Jackson | 2.15 | JSON处理 |
| Maven | 3.9 | 构建管理 |

#### 4.1.3 存储技术

| 技术 | 说明 |
|------|------|
| 文件系统 | 本地文件存储 |
| JSON格式 | EMF JSON序列化 |
| 内存缓存 | 简单查询缓存(可选) |

### 4.2 技术选型依据

1. **EMF (Eclipse Modeling Framework)**
   - 业界标准的模型驱动框架
   - 与SysML Pilot Implementation完全兼容
   - 提供完整的模型操作能力

2. **Spring Boot**
   - 成熟的企业级框架
   - 丰富的生态系统
   - 易于开发和部署

3. **React + TypeScript**
   - 现代前端技术栈
   - 组件化开发
   - 类型安全保证

4. **JSON文件存储**
   - 简化MVP实现
   - 易于调试和迁移
   - 满足当前规模需求

5. **动态EMF方法**
   - 无需生成Java代码
   - 运行时加载元模型
   - 灵活扩展新类型

---

## 5. 核心组件设计

### 5.1 组件架构图

```
┌────────────────────────────────────────────────┐
│                 前端组件                        │
├─────────────────┬──────────────┬───────────────┤
│   TreeView      │  TableView   │  GraphView    │
│   Component     │  Component   │  Component    │
└─────────────────┴──────────────┴───────────────┘
                         ↓
┌────────────────────────────────────────────────┐
│              后端核心组件                        │
├────────────────────────────────────────────────┤
│ Controller │ Domain Service │ EMF Service      │
├────────────────────────────────────────────────┤
│ Repository │ Model Registry │ Validator        │
└────────────────────────────────────────────────┘
```

### 5.2 组件职责

#### 5.2.1 前端组件

| 组件 | 职责 | 交互方式 |
|------|------|----------|
| TreeView | 展示模型层次结构 | 树形控件 |
| TableView | 展示平铺数据列表 | 表格+分页 |
| GraphView | 展示关系图谱 | 节点连线图 |
| ViewContext | 视图状态管理 | Context API |

#### 5.2.2 后端组件

| 组件 | 职责 | 关键接口 |
|------|------|----------|
| RequirementController | HTTP端点 | REST API |
| RequirementService | 需求业务逻辑、验证规则、视图编排 | 业务方法、验证方法 |
| UniversalElementService | EMF工具方法封装（无业务逻辑） | 纯技术的CRUD操作 |
| FileModelRepository | 文件持久化 | 加载、保存、导出 |
| EMFModelRegistry | 动态元模型注册 | 动态EPackage管理 |

---

## 6. 模型层架构（EMF）

### 6.1 EMF框架概述

Eclipse Modeling Framework (EMF) 是整个系统的核心模型管理框架，负责：
- **元模型定义**：定义SysML v2的模型结构
- **模型实例管理**：创建和管理具体的模型对象
- **模型操作**：提供统一的API访问和操作模型
- **模型验证**：确保模型符合元模型约束

### 6.2 模型层次结构

```
┌─────────────────────────────────────────────────────┐
│                  M3层 (元元模型)                      │
│                     Ecore Model                      │
│          (EMF的元模型，定义如何定义模型)               │
└─────────────────────────────────────────────────────┘
                         ↓ instance of
┌─────────────────────────────────────────────────────┐
│                   M2层 (元模型)                       │
│                 SysML.ecore (182个EClass)            │
│   RequirementDefinition | RequirementUsage | ...     │
└─────────────────────────────────────────────────────┘
                         ↓ instance of
┌─────────────────────────────────────────────────────┐
│                   M1层 (模型实例)                     │
│              具体的业务模型对象                        │
│   "电池容量需求" : RequirementDefinition             │
│   "50kWh电池包" : RequirementUsage                   │
└─────────────────────────────────────────────────────┘
```

### 6.3 EMF核心组件（动态EMF）

#### 6.3.1 动态元模型注册（Dynamic Model Registry）

```java
// 动态加载SysML元模型（不生成Java代码）
Resource resource = resourceSet.getResource(URI.createURI("SysML.ecore"), true);
EPackage sysmlPackage = (EPackage) resource.getContents().get(0);
// 使用运行时的nsURI，不硬编码
EPackage.Registry.INSTANCE.put(
    sysmlPackage.getNsURI(), 
    sysmlPackage
);
```

#### 6.3.2 动态模型创建（Dynamic Model Creation）

```java
// 动态创建模型实例（无需生成的Java类）
EClass reqDefClass = (EClass) sysmlPackage.getEClassifier("RequirementDefinition");
EObject reqDef = EcoreUtil.create(reqDefClass);
reqDef.eSet(reqDef.eClass().getEStructuralFeature("name"), "Battery Requirement");
```

#### 6.3.3 动态模型访问（Dynamic Model Access）

```java
// 动态访问元模型定义
EClass eClass = eObject.eClass();
EStructuralFeature feature = eClass.getEStructuralFeature("reqId");
Object value = eObject.eGet(feature);
```

### 6.4 模型操作接口

| 接口类型 | 功能 | 示例 |
|----------|------|------|
| **EObject** | 所有模型对象的基类 | element.eGet(feature) |
| **EClass** | 元类型定义 | eClass.getEAllAttributes() |
| **EStructuralFeature** | 属性和引用定义 | feature.isMany() |
| **Resource** | 模型资源管理 | resource.getContents() |
| **ResourceSet** | 资源集合管理 | resourceSet.getResource() |

### 6.5 模型层与其他层的交互

```
领域层 (Domain Service) → 业务逻辑、验证
    ↓
EMF工具层 (UniversalElementService) → 纯技术封装
    ↓ 调用EMF API
模型层 (EMF Framework)
    ├── 创建: EcoreUtil.create(eClass) [动态]
    ├── 查询: resource.getAllContents()
    ├── 更新: eObject.eSet(feature, value)
    └── 删除: EcoreUtil.delete(eObject)
    ↓ 序列化/反序列化
持久化层 (EMF Resource)
```

### 6.6 模型验证机制

EMF提供的模型验证能力：
1. **结构验证**：确保模型符合元模型定义
2. **约束验证**：检查业务规则约束
3. **引用完整性**：验证对象间引用的有效性
4. **多重性检查**：验证关系的数量约束

---

## 7. 数据架构

### 7.1 数据模型

#### 7.1.1 元模型结构 (M2)

```
SysML v2 Metamodel (182 EClasses)
├── Element (根类型)
│   ├── Namespace
│   │   ├── Type
│   │   │   ├── Classifier
│   │   │   │   ├── Definition
│   │   │   │   │   ├── RequirementDefinition
│   │   │   │   │   ├── PartDefinition
│   │   │   │   │   └── ...
│   │   │   │   └── Usage
│   │   │   │       ├── RequirementUsage
│   │   │   │       ├── PartUsage
│   │   │   │       └── ...
│   └── Relationship
│       ├── Dependency
│       ├── Satisfy
│       └── ...
```

#### 7.1.2 数据存储结构

```
data/
└── projects/
    └── {projectId}/
        ├── model.json        # EMF模型数据
        └── metadata.json     # 项目元数据
```

### 7.2 数据流转

#### 7.2.1 查询数据流

```
1. 用户请求 → 2. Controller接收 → 3. 调用Domain Service
     ↓
4. Domain Service业务逻辑 → 5. 调用EMF工具层
     ↓
6. EMF工具层调用EMF模型层 → 7. EMF查询Resource
     ↓
8. 持久化层加载JSON文件 → 9. EMF反序列化为EObject
     ↓
10. 返回模型对象到EMF工具层 → 11. 返回给Domain Service
     ↓
12. 构建视图DTO → 13. 返回前端展示
```

#### 7.2.2 更新数据流

```
1. 用户提交 → 2. Controller验证 → 3. 调用Domain Service
     ↓
4. Domain Service业务校验 → 5. 调用EMF工具层操作
     ↓
6. EMF工具层调用EMF模型层 → 7. EMF创建/修改模型对象
     ↓
8. Domain Service业务验证 → 9. 持久化层处理Resource
     ↓
10. EMF序列化为JSON → 11. 写入文件系统
     ↓
12. 返回操作结果 → 13. 响应用户
```

---

## 7. 接口设计

### 7.1 API设计原则

- **RESTful风格**: 资源导向，使用HTTP动词
- **统一响应格式**: 标准化的成功/错误响应
- **版本管理**: URL路径包含版本号
- **分页支持**: 标准分页参数(page从0开始，size默认50最大200)
- **时间戳管理**: createdAt/updatedAt由服务器生成和维护，客户端传入将被忽略

### 7.2 核心API

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/requirements` | GET | 查询需求列表 |
| `/api/v1/requirements/{id}` | GET | 获取单个需求 |
| `/api/v1/requirements` | POST | 创建新需求 |
| `/api/v1/requirements/{id}` | PUT | 更新需求 |
| `/api/v1/requirements/{id}` | DELETE | 删除需求 |
| `/api/v1/requirements/tree` | GET | 获取需求树视图 |
| `/api/v1/requirements/graph` | GET | 获取需求关系图 |
| `/api/v1/requirements/validate` | POST | 验证需求模型 |
| `/api/v1/parts` | GET | 查询部件列表 |
| `/api/v1/parts/{id}` | GET | 获取单个部件 |
| `/api/v1/parts` | POST | 创建新部件 |
| `/api/v1/parts/{id}` | PUT | 更新部件 |
| `/api/v1/parts/{id}` | DELETE | 删除部件 |
| `/api/v1/projects/{pid}/export` | GET | 导出项目(EMF JSON) |
| `/api/v1/projects/{pid}/import` | POST | 导入项目(EMF JSON) |

### 7.3 验证规则和错误码

| 规则码 | 说明 | HTTP状态码 |
|--------|------|------------|
| `DUP_REQID` | reqId重复 | 409 Conflict |
| `CYCLE_DERIVE_REFINE` | derive/refine关系存在循环 | 400 Bad Request |
| `BROKEN_REF` | 引用的元素不存在 | 400 Bad Request |

验证接口返回格式：
```json
{
  "valid": false,
  "errors": [
    {
      "ruleCode": "DUP_REQID",
      "elementId": "xxx",
      "message": "reqId 'REQ-001' already exists"
    }
  ]
}
```

---

## 8. 部署架构

### 8.1 部署视图

```
┌─────────────────────────────────┐
│      Web Server (Nginx)         │
│         端口: 80/443            │
└─────────────────────────────────┘
              ↓
       ┌──────────────┐
       │ Spring Boot  │
       │   单实例      │
       │    :8080     │
       └──────────────┘
              ↓
       ┌──────────────┐
       │  文件系统     │
       │ (本地存储)    │
       └──────────────┘
```

### 8.2 部署环境

| 环境 | 用途 | 配置 |
|------|------|------|
| 开发环境 | 开发测试 | 单机部署 |
| 测试环境 | 集成测试 | 单机部署 |
| 生产环境 | 正式运行 | 单实例部署（MVP阶段） |

---

## 9. 性能设计

### 9.1 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 响应时间 | <500ms | API平均响应时间 |
| 并发用户 | 50 | 同时在线用户数 |
| 模型规模 | ≤500节点 | 单个项目最大节点数 |
| 文件大小 | <10MB | 单个模型文件大小 |

### 9.2 性能优化策略

1. **前端优化**
   - 虚拟滚动处理大数据列表
   - 懒加载树节点
   - 防抖节流用户操作

2. **后端优化**
   - 简单查询缓存（仅用于只读查询，写操作后清除）
   - 批量操作减少IO
   - 同步处理保证数据一致性

3. **存储优化**
   - JSON压缩存储
   - 增量保存机制
   - 定期清理历史版本

---

## 10. 安全设计

### 10.1 安全架构

| 层次 | 安全措施 |
|------|----------|
| 网络层 | HTTPS加密传输 |
| 应用层 | JWT身份认证 |
| 业务层 | 权限访问控制 |
| 数据层 | 文件权限隔离 |

### 10.2 安全策略

1. **身份认证**: JWT Token认证机制
2. **授权管理**: 基于角色的访问控制(RBAC)
3. **数据保护**: 敏感数据加密存储
4. **审计日志**: 关键操作日志记录

---

## 11. 可扩展性设计

### 11.1 扩展点设计

| 扩展点 | 说明 | 实现方式 |
|--------|------|----------|
| 新增SysML类型 | 支持更多模型元素 | 动态EMF，无需重新编译 |
| 新增视图 | 添加新的展示方式 | 前端组件+后端API |
| 新增验证规则 | 扩展业务规则 | 策略模式+配置化 |
| 存储方式 | 支持数据库存储 | Repository接口抽象 |

### 11.2 未来演进路线

```
Phase 1 (当前MVP)
├── 基础建模能力
├── 三种视图
└── 文件存储

Phase 2 (扩展版)
├── 完整SysML支持
├── 协作功能
└── 版本管理

Phase 3 (企业版)
├── 数据库存储
├── 集成第三方工具
└── 高级分析功能
```

---

## 12. 风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| EMF学习曲线陡峭 | 开发效率低 | 技术培训+示例代码 |
| 文件存储性能瓶颈 | 大模型响应慢 | 预留数据库迁移接口 |
| 前后端数据同步 | 状态不一致 | 统一状态管理机制 |
| 模型复杂度增长 | 维护困难 | 模块化设计+充分测试 |

---

## 附录A：参考资料

1. OMG SysML v2 Specification
2. Eclipse EMF Documentation
3. Spring Boot Reference Guide
4. React Documentation
5. SysML v2 Pilot Implementation

## 附录B：版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2025-08-25 | 架构团队 | 初始版本 |