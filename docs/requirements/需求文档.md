# SysML v2 建模平台 MVP 需求书 v2.1

## 文档信息

- **版本**: 2.1
- **日期**: 2025-08
- **状态**: MVP 定稿
- **调整说明**: 在 v2.0 基础上合入必改项与标准化条款：Usage 时间戳、JSON/$ref 约定、零 Pilot 依赖声明、校验规则枚举、导出文件名、健康检查字段、Graph `rootId` 语义、分页上限等。

---

## 0) 术语与优先级

- **优先级**：P0=必须（MVP）、P1=可选（次要）、P2=后续
- **SSOT**：Single Source of Truth，唯一事实来源（M1 EMF Resource）
- **元素类型**：`RequirementDefinition` / `RequirementUsage` / `Trace`

---

## 通用接口与数据约定（规范化补充）

- **时间戳格式**：所有 `createdAt/updatedAt` 采用 **ISO-8601 UTC**（`YYYY-MM-DDTHH:mm:ss.SSSZ`）。
- **ID 稳定性**：对象 `id` 在导出/导入、进程重启后保持不变。
- **分页约定**：`page` 从 `0` 起，`size` ∈ (1..200]，默认 `size=50`。若超出范围返回 `400`。
- **大小写约定**：`Trace.type` 小写、**区分大小写**（`derive|satisfy|refine|trace`）。
- **JSON/序列化约定（EMF JSON）**：
  - 模型对象包含 `eClass` 标识类型；根对象可选 `"$id"`；跨引用统一以 `"$ref":"<id>"` 表示。
  - 存在循环关系的字段一律以 `$ref` 序列化，禁止递归嵌套。
  - 未识别字段应保留（round-trip 不丢失）。
- **导出文件名**：`Content-Disposition: attachment; filename="project-{pid}.json"`。
- **空数据响应**：列表类接口空集合返回 `200` + `[]`（不使用 204）。
- **错误码基线**：`400`（参数/格式错误）、`404`（目标不存在）、`409`（冲突/被引用）、`201`（创建成功）、`204`（删除成功无内容）。

---

## EPIC A｜架构与数据一致性（P0）

### Story A1｜单一数据源（SSOT）

**As** 系统 **I want** 只有一个 M1 资源作为事实来源 **so that** 树/表/图一致。

**Requirements**

- **REQ-A1-1** 数据源唯一
  - **AC**：Given 系统运行，When 任一视图对对象创建/更新，Then 另两视图**在不刷新**情况下看到同一 `id` 的同步变更。
- **REQ-A1-2** 视图为投影
  - **AC**：树/表/图不得各自持久化副本；只读导出（快照）**不得作为并行数据源**编辑。
- **REQ-A1-3** 性能底线（已调整）
  - **AC**：在 **500 节点/1000 边** 模型上，视图联动平均响应 < **500ms**；超出规模自动启用分页/懒加载。

### Story A2｜健康检查（新增）

**As** 运维 **I want** 系统健康检查端点 **so that** 快速诊断问题。

**Requirements**

- **REQ-A2-1** 基础健康检查
  - **AC**：`GET /health` 响应 `{"status":"UP"|"DOWN","buildVersion","gitCommit","serverTimeUtc"}`；响应 < **100ms**（开发机）。
- **REQ-A2-2** EMF 模型健康
  - **AC**：`GET /health/model` 返回已注册 `EPackage` 列表与来源标识（应包含 `urn:your:sysml2`，来源 `local`）。

---

## EPIC B｜EMF 基座与持久化（P0）

### Story B1｜本地 Ecore & JSON 资源工厂

**As** 平台 **I want** 本地 SysML2 子集 Ecore 与 JSON 序列化 **so that** 文件即模型。

**Requirements**

- **REQ-B1-1** 本地包注册（零 Pilot 依赖）
  - **AC**：启动将本地 `urn:your:sysml2` `EPackage` 注册进 `EPackage.Registry`；运行时**不得**加载 `org.omg.sysml*`/Pilot 实现；`/health/model` 可见并标注来源 `local`。
- **REQ-B1-2** JSON 工厂
  - **AC**：为 `.json` 注册 EMF JSON 资源工厂；`ResourceSet` 能创建/加载/保存；模型根包含 `_version:"1.0"`。
- **REQ-B1-3** 回读一致性（增强）
  - **AC**：新建→保存→再加载：根数量、`eClass`、`id` 完全一致；未知字段保留；循环引用以 `$ref` 序列化且能回读。
- **REQ-B1-4** Demo 数据
  - **AC**：仓库含 `demo-project.json`（≥8 Definition、≥5 Trace）；另提供 `small(10)` / `medium(100)` / `large(500)` 三套数据集。

### Story B2｜统一工厂创建

**As** 开发者 **I want** 用统一接口创建对象 **so that** 默认值一致可控。

**Requirements**

- **REQ-B2-1** 创建 API
  - **AC**：提供 `createDefinition()` / `createUsage(ofId)` / `createTrace(fromId,toId,type)`；缺参→`400`。
- **REQ-B2-2** 默认值
  - **AC**：新建默认 `status='draft'`,`tags=[]`；ID 采用稳定 UUID（或 `R-/U-/T-` 前缀+序号）。
- **REQ-B2-3** ID 稳定
  - **AC**：导出→导入后，同一对象 `id` 不变。

### Story B3｜项目导入/导出（JSON）

**As** 用户 **I want** 项目落盘与恢复 **so that** 可迁移与演示。

**Requirements**

- **REQ-B3-1** 导出 JSON
  - **AC**：`GET /projects/{pid}/export` 返回 `application/json`，并附规范文件名（见通用约定）。
- **REQ-B3-2** 导入 JSON
  - **AC**：`POST /projects/{pid}/import` 成功导入；非法文件返回**行/列/原因**。
- **REQ-B3-3** 一致性
  - **AC**：导出后再导入，元素计数、交叉引用与 `id` 完全一致。

> 注：XMI 支持 **P2**；CSV 导入 **P1**（列：`reqId,name,text,tags`）。

### Story B4｜快速原型验证（P1）

**As** 开发者 **I want** CLI **so that** 不依赖前端快速验证模型。

- **AC**：提供 Spring Shell 命令：`create-req`、`list-req`、`create-trace`。

---

## EPIC C｜需求与追溯 CRUD（P0）

### Story C1｜RequirementDefinition CRUD

**As** 分析师 **I want** 管理 Definition **so that** 形成标准化 shall。

**Requirements**

- **REQ-C1-1** 创建
  - **AC**：`POST /requirements`（`type=definition`）缺 `reqId|name|text` → `400`；成功 `201` 返回对象与 `Location`。
- **REQ-C1-2** 读/改/删
  - **AC**：`GET|PUT|DELETE /requirements/{id}` 可用；允许更新 `name,text,doc,tags,subjectRef,constraints?,assumptions?`；被引用删除 → `409`。
- **REQ-C1-3** `reqId` 唯一
  - **AC**：创建/更新触发唯一性校验；冲突返回 `409` 并给出冲突对象 `id` 列表。

### Story C2｜RequirementUsage CRUD

**As** 分析师 **I want** 基于 Definition 实例化 **so that** 复用与分配。

**Requirements**

- **REQ-C2-1** 创建
  - **AC**：`POST /requirements`（`type=usage, of=defId`）；缺 `of` → `400`；`defId` 不存在 → `404`。
- **REQ-C2-2** 读/改/删
  - **AC**：更新允许 `name,text,status,tags`；存在 Trace 时删除 → `409`（返回阻塞 `traceIds`）。

### Story C3｜Trace CRUD

**As** 用户 **I want** 建立追溯 **so that** 可视化与校验。

**Requirements**

- **REQ-C3-1** 创建（增强）
  - **AC**：`POST /requirements/{id}/traces {toId,type}`；`type∈{derive,satisfy,refine,trace}`；`fromId==toId` → `400`；`toId` 不存在 → `404`；成功对象含 `createdAt`（UTC）。
- **REQ-C3-2** 查询
  - **AC**：`GET /requirements/{id}/traces?dir=in|out|both` 返回入/出边。
- **REQ-C3-3** 去重
  - **AC**：同 `(from,to,type)` 不重复创建；重复请求返回既有对象 `200`。
- **REQ-C3-4** 删除
  - **AC**：`DELETE /traces/{traceId}` → `204`；不存在 → `404`。

> 注：`verify` 与 `VerificationCase` **P2**（MVP 不实现）。

---

## EPIC D｜三视图联动（P0）

### Story D1｜树视图

**As** 用户 **I want** 层级浏览与轻编辑 **so that** 快速定位。

**Requirements**

- **REQ-D1-1** 接口
  - **AC**：`GET /tree` 返回 Definition 为父、Usage 为子；支持懒加载。
- **REQ-D1-2** 写回
  - **AC**：创建/重命名/拖拽改层级触发 REST 写回；非法层级变更 → `400`。
- **REQ-D1-3** 联动
  - **AC**：树选中项在表/图中高亮同一 `id`。

### Story D2｜表视图（已简化）

**As** 用户 **I want** 批量筛选与操作 **so that** 高效处理。

**Requirements**

- **REQ-D2-1** 接口
  - **AC**：`GET /table?page&size&sort&q`，列包含 `reqId,name,type,tags,status`；支持虚拟滚动（不设渲染阈值）。
- **REQ-D2-2** 联动
  - **AC**：点击表行联动树/图高亮。

### Story D3｜图视图（React Flow）

**As** 用户 **I want** 直观查看关系 **so that** 追溯清晰。

**Requirements**

- **REQ-D3-1** 接口
  - **AC**：`GET /graph?rootId` 返回 `nodes/edges`；节点含 `id,type,label`，边含 `from,to,type`。当 `rootId` 为空时返回分页/窗口化**全局子图**（与前端懒加载策略一致）。
- **REQ-D3-2** 连线/删线
  - **AC**：连线/删线分别调用 Trace 创建/删除；失败**回滚 UI**并提示原因。
- **REQ-D3-3** 自动布局（已调整）
  - **AC**：提供“自动布局”（dagre/elkjs）；**≤500 节点**布局完成 < **3s**；交互流畅。

> 追踪矩阵 **P2**（MVP 不实现）。

---

## EPIC E｜静态校验（P0，已简化）

### Story E1｜核心静态校验

**As** 用户 **I want** 一键发现关键问题 **so that** 保证基本质量。

**Requirements**

- **REQ-E1-1** MVP 规则集
  - **AC**：仅检测 **(1)** `reqId` 唯一（Definitions），**(2)** `derive/refine` 循环依赖，**(3)** 悬挂引用（`fromId/toId` 不存在）。
- **REQ-E1-2** 规则码（固定枚举）
  - **AC**：返回 `ruleCode∈{DUP_REQID, CYCLE_DERIVE_REFINE, BROKEN_REF}`，示例：`{"ruleCode":"DUP_REQID","targetId":"R-12","message":"reqId duplicated: REQ-001"}`。
- **REQ-E1-3** 接口返回
  - **AC**：`POST /validate/static {ids?:[]}` → `{violations:[{ruleCode,targetId,message,details?}]}`；**≤500 元素**处理 < **2s**。
- **REQ-E1-4** 前端呈现
  - **AC**：违规对象在视图中高亮；可导出 **JSON 报告**（CSV 导出为 **P1**）。

> Resolved/表达式求值 **P2**（MVP 不启用）。

---

## EPIC F｜依赖与交付（P0）

### Story F1｜离线构建与镜像

**As** DevOps **I want** 构建与运行不依赖外网 **so that** 可在内网/断网稳定交付。

**Requirements**

- **REQ-F1-1** Maven 镜像
  - **AC**：提供 `settings.offline.xml`，`<mirrorOf>*</mirrorOf>` 指向内网或 `file:` 仓库；`mvn -o -s settings.offline.xml verify` 成功。
- **REQ-F1-2** 供应链守门
  - **AC**：启用 `maven-enforcer` 禁止非白名单仓库；生成 SBOM，依赖仅指向内网域/`file:`。

---

## 数据模型（MVP 字段约定，已增强）

```yaml
RequirementDefinition:
  - id: string
  - reqId: string (unique)
  - name: string
  - doc: string
  - text: string
  - tags: string[]
  - _version: string (default: "1.0")
  - createdAt: timestamp   # ISO-8601 UTC
  - updatedAt: timestamp   # ISO-8601 UTC

RequirementUsage:
  - id: string
  - of: string             # defId reference
  - name: string
  - text: string (optional)
  - status: string
  - tags: string[] (optional)
  - _version: string (default: "1.0")
  - createdAt: timestamp   # ISO-8601 UTC  [新增]
  - updatedAt: timestamp   # ISO-8601 UTC  [新增]

Trace:
  - id: string
  - fromId: string
  - toId: string
  - type: enum ('derive'|'satisfy'|'refine'|'trace')  # lowercase, case-sensitive
  - createdAt: timestamp   # ISO-8601 UTC  [新增]

Project:
  - id: string
  - name: string
  - createdAt: timestamp
  - updatedAt: timestamp
  - _version: string (default: "1.0")
```
