# SysML v2 建模平台 MVP 需求书 v3.1

## 文档信息

- **版本**: 3.1
- **日期**: 2025-08-24
- **状态**: 通用接口架构+工程约束定稿
- **调整说明**: 基于v3.0，新增关键工程约束：Usage必须指明约束对象（subject）、参数化文本渲染、QUDV单位量纲校验、Definition-Usage类型配对、追溯语义约束等。确保需求管理的追溯链闭环和可验证性。

---

## 0) 术语与优先级

- **优先级**：P0=必须（MVP）、P1=可选（次要）、P2=后续
- **SSOT**：Single Source of Truth，唯一事实来源（M1 EMF Resource）
- **元素类型**：支持所有182个SysML Pilot类型（通过`eClass`参数动态指定）

---

## 通用接口与数据约定（规范化补充）

- **时间戳格式**：所有 `createdAt/updatedAt` 采用 **ISO-8601 UTC**（`YYYY-MM-DDTHH:mm:ss.SSSZ`）。
- **ID 稳定性**：对象 `id` 在导出/导入、进程重启后保持不变。
- **分页约定**：`page` 从 `0` 起，`size` ∈ (1..200]，默认 `size=50`。若超出范围返回 `400`。
- **大小写约定**：`Trace.type` 小写、**区分大小写**（`derive|satisfy|refine|trace`）。
- **JSON/序列化约定（EMF JSON）**：
  - 模型对象包含 `eClass` 标识类型；根对象可选 `"$id"`；跨引用统一以 `"$ref":"<id>"` 表示。
  - 存在循环关系的字段一律以 `$ref` 序列化，禁止递归嵌套。
  - 未识别字段应保留（round-trip 不丢失）。
  - JSON根对象包含命名空间定义：`"ns": {"sysml": "<运行时加载的SysML命名空间URI>"}`。
  - **实现提示**（非AC）：推荐使用sirius-emfjson库，设置`OPTION_FORCE_DEFAULT_REFERENCE_SERIALIZATION=true`避免循环引用。
- **导出文件名**：`Content-Disposition: attachment; filename="project-{pid}.json"`。
- **空数据响应**：列表类接口空集合返回 `200` + `[]`（不使用 204）。
- **错误码基线**：`400`（参数/格式错误）、`404`（目标不存在）、`409`（冲突/被引用）、`201`（创建成功）、`204`（删除成功无内容）。

---

## EPIC A｜架构与数据一致性（P0）

### Story A1｜单一数据源（SSOT）

**As** 系统 **I want** 只有一个 M1 资源作为事实来源 **so that** 树/表/图一致。

**Requirements**

- **REQ-A1-1** 数据源唯一
  - **AC**：Given 系统运行，When 任一视图对对象创建/更新，Then 另两视图**在不刷新**情况下看到同一 `id` 的同步变更。
- **REQ-A1-2** 视图为投影
  - **AC**：树/表/图不得各自持久化副本；只读导出（快照）**不得作为并行数据源**编辑。
- **REQ-A1-3** 性能底线（已调整）
  - **AC**：在 **500 节点/1000 边** 模型上，视图联动平均响应 < **500ms**；超出规模自动启用分页/懒加载。

### Story A2｜健康检查（新增）

**As** 运维 **I want** 系统健康检查端点 **so that** 快速诊断问题。

**Requirements**

- **REQ-A2-1** 基础健康检查
  - **AC**：`GET /health` 响应 `{"status":"UP"|"DOWN","buildVersion","gitCommit","serverTimeUtc"}`；响应 < **100ms**（开发机）。
- **REQ-A2-2** EMF 模型健康
  - **AC**：`GET /health/model` 返回已注册 `EPackage` 摘要信息：总数、每个包的完整nsURI（如`https://www.omg.org/spec/SysML/20250201`）；支持 `?detailed=true` 返回完整EClass列表。

---

## EPIC B｜EMF 基座与持久化（P0）

### Story B1｜完整Pilot Ecore注册 & JSON资源工厂

**As** 平台 **I want** 注册完整的SysML Pilot元模型与JSON序列化 **so that** 完全兼容SysML 2.0标准并支持未来扩展。

**Requirements**

- **REQ-B1-1** 完整Pilot元模型注册
  - **AC**：启动时加载完整的SysML.ecore文件，注册所有EClass到 `EPackage.Registry`；使用运行时加载的Pilot标准命名空间（不硬编码日期）；包含完整继承层次（Element→NamedElement→Feature→Type→Classifier→Definition→OccurrenceDefinition→ConstraintDefinition→RequirementDefinition）；EMF自动处理所有继承关系，子类可访问所有父类属性。
- **REQ-B1-2** JSON 工厂
  - **AC**：为 `.json` 注册 EMF JSON 资源工厂；`ResourceSet` 能创建/加载/保存；模型根包含 `_version:"1.0"`。
- **REQ-B1-3** 回读一致性（增强）
  - **AC**：新建→保存→再加载：根数量、`eClass`、`id` 完全一致；未知字段保留；循环引用以 `$ref` 序列化且能回读。
- **REQ-B1-4** Demo 数据
  - **AC**：仓库含 `demo-project.json`（≥8 Definition、≥5 Trace）；另提供 `small(10)` / `medium(100)` / `large(500)` 三套数据集。
  - **领域演示数据**：提供汽车电池系统（EV Battery System）的需求库和实例：
    - **需求库（RequirementDefinition）- 约15-20个模板**：
      - L1系统级（3-5个）：电池系统整体需求模板（性能、安全、寿命）
      - L2子系统级（5-8个）：BMS、热管理、电芯组、高压配电等子系统需求模板
      - L3组件级（7-10个）：传感器、控制器、冷却单元等组件需求模板
    - **需求实例（RequirementUsage）- 50个实例**：
      - 基于需求库模板创建的具体应用实例
      - 每个Definition可被多个Usage引用（体现复用）
      - 示例：
        - "温度监控需求"（Definition）→ BMS温度监控、充电温度监控、放电温度监控（多个Usage）
        - "功能安全需求"（Definition）→ 过充保护、过放保护、短路保护（多个Usage）
    - **追溯关系（15-20个）**：Usage之间的satisfy、derive、refine关系
  - **典型字段要求**：
    - Definition字段：`declaredShortName`（需求编号）、`declaredName`、`documentation`（标准需求文本）
    - Usage字段：`declaredShortName`（实例编号）、`of`（引用的Definition）、`status`、实施细节
    - 包含领域特定属性：`priority`（P0/P1/P2）、`verificationMethod`（test/analysis/inspection/demonstration）
  - **数据质量**：
    - 需求文本符合工程规范（使用shall语句）
    - reqId遵循层次编码（如EBS-L1-001、EBS-L2-BMS-001）
    - 包含实际工程意义的需求内容，非占位符文本

### Story B2｜统一工厂创建与DTO映射

**As** 开发者 **I want** 统一的对象创建和DTO映射机制 **so that** API简洁而存储完整。

> **Service层内部API说明**：
> - `createDefinition()` - 创建RequirementDefinition
> - `createUsage(ofId)` - 创建RequirementUsage  
> - `createTraceDependency(fromId, toId, type)` - 创建追溯关系（内部为Dependency，对外API显示为Trace）
>
> **API层 ↔ Service层映射对照表**：
> | API层概念 | Service/Pilot层概念 | 说明 |
> |----------|-------------------|------|
> | Trace | Dependency | REST API使用Trace，内部实现为Dependency |
> | fromId | source.elementId | 追溯关系源端 |
> | toId | target.elementId | 追溯关系目标端 |
> | type | 扩展属性/stereotype | derive/satisfy/refine/trace |

**Requirements**

- **REQ-B2-1** 创建 API
  - **AC**：提供 `createDefinition()` / `createUsage(ofId)` / `createTraceDependency(fromId,toId,type)`；缺参→`400`。
- **REQ-B2-2** 默认值
  - **AC**：新建时自动设置继承字段默认值；ID采用稳定UUID（或 `R-/U-/D-` 前缀+序号）。
- **REQ-B2-3** ID 稳定
  - **AC**：导出→导入后，同一对象 `id` 不变。
- **REQ-B2-4** DTO选择性映射
  - **AC**：DTO只包含需要的字段（id、name、reqId、text等）；Service层负责DTO与完整EObject之间的映射；未映射的继承字段保持默认值或null；所有继承字段通过eGet/eSet可访问。

### Story B3｜项目导入/导出（JSON）

**As** 用户 **I want** 项目落盘与恢复 **so that** 可迁移与演示。

**Requirements**

- **REQ-B3-1** 导出 JSON
  - **AC**：`GET /api/v1/projects/{pid}/export` 返回 `application/json`，并附规范文件名（见通用约定）。
- **REQ-B3-2** 导入 JSON
  - **AC**：`POST /api/v1/projects/{pid}/import` 成功导入；非法文件返回**行/列/原因**。
- **REQ-B3-3** 一致性
  - **AC**：导出后再导入，元素计数、交叉引用与 `id` 完全一致。

> 注：XMI 支持 **P2**；CSV 导入 **P1**（列：`reqId,name,text,tags`）。

### Story B4｜快速原型验证（P1）

**As** 开发者 **I want** CLI **so that** 不依赖前端快速验证模型。

- **AC**：提供 Spring Shell 命令：`create-req`、`list-req`、`create-trace`。

### Story B5｜通用元素接口（P0）

**As** 开发者 **I want** 通用的元素操作接口 **so that** 可以操作任意SysML元素类型而无需为每个类型编写专门代码。

**Requirements**

- **REQ-B5-1** 通用创建接口
  - **AC**：`POST /api/v1/elements` 接受 `{eClass, attributes}` 创建任意SysML元素；成功返回201；未知eClass返回400。
- **REQ-B5-2** 按类型查询
  - **AC**：`GET /api/v1/elements?type={eClassName}` 返回指定类型的所有元素；支持分页；type为空返回所有元素。
- **REQ-B5-3** 通用PATCH更新
  - **AC**：`PATCH /api/v1/elements/{id}` 部分更新任意元素；只更新提供的字段；元素不存在返回404。
- **REQ-B5-4** 零代码扩展验证
  - **AC**：无需修改代码即可支持新的SysML类型（如PartUsage、InterfaceDefinition等）；通过测试验证至少3种不同类型。
- **REQ-B5-5** QUDV单位量纲校验
  - **AC**：填写数值参数时（如window、flow、pressure等），单位与量纲必须匹配标准QUDV定义：
    - Duration类型必须使用时间单位（s、min、h、day）
    - Mass类型必须使用质量单位（kg、g、lb）
    - Pressure类型必须使用压力单位（Pa、bar、psi）
    - Power类型必须使用功率单位（W、kW、hp）
    - 量纲不匹配 → `400`，返回期望的单位类型；确保需求可验证性和单位一致性。

---

## EPIC C｜通用接口应用示例（需求与追溯）（P0）

> **架构说明**：本EPIC展示如何使用通用元素接口（REQ-B5-1到B5-4）处理需求和追溯管理。所有操作都通过`/api/v1/elements`端点实现，无需专门的需求CRUD接口。

### Story C1｜RequirementDefinition 管理

**As** 分析师 **I want** 通过通用接口管理需求定义 **so that** 享受零代码扩展的优势。

> **字段映射**：
>
> - API `reqId` → Pilot `declaredShortName`（唯一业务标识）
> - API `text` → Pilot `documentation.body`（需求文本）
> - API `name` → Pilot `declaredName`（显示名称）

**Requirements**

- **REQ-C1-1** 通过通用接口创建需求定义
  - **AC**：`POST /api/v1/elements {"eClass": "RequirementDefinition", "attributes": {"declaredShortName": "REQ-001", "declaredName": "性能需求"}}`；成功 `201` 返回ElementDTO；缺少必填字段 → `400`。
- **REQ-C1-2** 通过通用接口查询需求定义
  - **AC**：`GET /api/v1/elements?type=RequirementDefinition` 返回所有需求定义；支持分页；`GET /api/v1/elements/{id}` 返回特定需求。
- **REQ-C1-3** 通过通用接口更新需求定义
  - **AC**：`PATCH /api/v1/elements/{id} {"declaredName": "更新的名称"}` 部分更新；只更新提供的字段；被引用删除 → `409`。
- **REQ-C1-4** 参数化文本渲染（需求模板化）
  - **AC**：Definition支持`${}`占位符语法，如`"The ${subject} shall achieve ${performance} within ${window}."`；Usage绑定具体参数值后自动生成渲染文本`renderedText`字段；占位符缺失绑定值时保持原样；渲染文本可读可检索。

### Story C2｜RequirementUsage 管理

**As** 分析师 **I want** 通过通用接口管理需求使用实例 **so that** 体现Definition-Usage复用模式。

**Requirements**

- **REQ-C2-1** 通过通用接口创建需求使用
  - **AC**：`POST /api/v1/elements {"eClass": "RequirementUsage", "attributes": {"declaredShortName": "REQ-001-U1", "of": "defId", "subject": "targetId"}}`；`of`引用的Definition不存在 → `404`；`subject`引用的约束对象不存在 → `404`。
- **REQ-C2-2** Usage与Definition关联验证
  - **AC**：创建的RequirementUsage的`of`字段正确引用对应的RequirementDefinition；查询时能获取完整的引用关系。
- **REQ-C2-3** 约束对象（subject）必填约束
  - **AC**：RequirementUsage必须填写`subject`字段指明约束对象；`PATCH /api/v1/elements/{id} {"subject": "targetId"}`；缺失`subject`或指向不存在元素 → `400`/`404`；确保追溯链闭环。
- **REQ-C2-4** Definition-Usage类型配对约束
  - **AC**：RequirementUsage.of只能指向RequirementDefinition类型（错配 → `400`）；删除Definition前检查被引用保护（存在Usage引用时 → `409`）。
- **REQ-C2-5** 参数化文本绑定
  - **AC**：Usage可绑定Definition模板中的占位符参数，如`{"parameters": {"subject": "Engine", "performance": "100kW", "window": "10min"}}`；绑定后自动生成`renderedText`；参数类型与单位校验（如Duration类型必须有时间单位）。

### Story C3｜Dependency（Trace）管理

**As** 用户 **I want** 通过通用接口建立元素间的依赖关系 **so that** 实现追溯可视化。

> **映射说明**：追溯关系使用Pilot标准的"Dependency"类实现：
>
> - 创建：`POST /api/v1/elements {"eClass": "Dependency"}`
> - `source` → 源元素引用
> - `target` → 目标元素引用  
> - 可扩展支持DeriveRequirement、Satisfy、Refine等专门类型

**Requirements**

- **REQ-C3-1** 通过通用接口创建依赖关系
  - **AC**：`POST /api/v1/elements {"eClass": "Dependency", "attributes": {"source": "fromId", "target": "toId"}}`；`fromId==toId` → `400`；引用不存在 → `404`。
- **REQ-C3-2** 支持专门依赖类型
  - **AC**：支持创建`DeriveRequirement`、`Satisfy`、`Refine`等专门依赖类型；`GET /api/v1/elements?type=Dependency` 查询所有依赖关系。
- **REQ-C3-3** 依赖关系去重
  - **AC**：相同`(source,target,eClass)`的依赖不重复创建；重复请求返回既有对象 `200`。
- **REQ-C3-4** 追溯语义约束（最小规则）
  - **AC**：
    - `Satisfy`: source ∈ {PartUsage, ActionUsage, Function*}，target ∈ {RequirementUsage, RequirementDefinition}（实现满足需求）
    - `DeriveRequirement`: source/target ∈ {RequirementDefinition, RequirementUsage}（需求派生需求）
    - `Refine`: source/target ∈ {RequirementDefinition, RequirementUsage}（需求细化需求）
    - `Verify`: source ∈ {TestCase, VerificationCase}，target ∈ {RequirementUsage}（验证用例验证需求）
    - 违反类型约束 → `400`；防止追溯图被滥连，确保语义正确性。

> 注：通用接口的优势在于，未来如需支持其他SysML依赖类型（如`FeatureTyping`、`Subsetting`等），无需修改任何代码。

---

## EPIC D｜三视图联动（P0）

### Story D0｜前端数据初始化

**As** 用户 **I want** 前端能自动加载项目数据 **so that** 打开页面即可看到需求内容。

**Requirements**

- **REQ-D0-1** 通用元素数据API
  - **AC**：`GET /api/v1/elements` 返回所有元素；`GET /api/v1/elements?type=RequirementDefinition` 返回需求定义；`GET /api/v1/elements?type=RequirementUsage` 返回需求使用；每个ElementDTO包含`eClass`字段标识类型。
- **REQ-D0-2** 依赖关系数据API
  - **AC**：`GET /api/v1/elements?type=Dependency` 返回所有依赖关系；支持查询其他依赖类型如`DeriveRequirement`、`Satisfy`等。
- **REQ-D0-3** 前端自动加载
  - **AC**：前端启动时通过通用接口加载数据；根据ElementDTO的`eClass`字段区分不同类型；支持动态处理新的SysML类型。

### Story D1｜树视图

**As** 用户 **I want** 层级浏览与轻编辑 **so that** 快速定位。

**Requirements**

- **REQ-D1-1** 接口
  - **AC**：`GET /api/v1/tree` 返回 Definition 为父、Usage 为子；支持懒加载。
- **REQ-D1-2** 写回
  - **AC**：创建/重命名/拖拽改层级触发 REST 写回；非法层级变更 → `400`。
- **REQ-D1-3** 联动
  - **AC**：树选中项在表/图中高亮同一 `id`。

### Story D2｜表视图（已简化）

**As** 用户 **I want** 批量筛选与操作 **so that** 高效处理。

**Requirements**

- **REQ-D2-1** 接口
  - **AC**：`GET /api/v1/table?page&size&sort&q`，列包含 `reqId,name,type,tags,status`；支持虚拟滚动（不设渲染阈值）。
- **REQ-D2-2** 联动
  - **AC**：点击表行联动树/图高亮。

### Story D3｜图视图（React Flow）

**As** 用户 **I want** 直观查看关系 **so that** 追溯清晰。

**Requirements**

- **REQ-D3-1** 接口
  - **AC**：`GET /api/v1/graph?rootId` 返回 `nodes/edges`；节点含 `id,type,label`，边含 `from,to,type`。当 `rootId` 为空时返回分页/窗口化**全局子图**（与前端懒加载策略一致）。
- **REQ-D3-2** 连线/删线
  - **AC**：连线/删线分别调用 Trace 创建/删除；失败**回滚 UI**并提示原因。
- **REQ-D3-3** 自动布局（已调整）
  - **AC**：提供“自动布局”（dagre/elkjs）；**≤500 节点**布局完成 < **3s**；交互流畅。

> 追踪矩阵 **P2**（MVP 不实现）。

---

## EPIC E｜静态校验（P0，已简化）

### Story E1｜核心静态校验

**As** 用户 **I want** 一键发现关键问题 **so that** 保证基本质量。

**Requirements**

- **REQ-E1-1** MVP 规则集
  - **AC**：仅检测 **(1)** `reqId` 唯一（Definitions），**(2)** `derive/refine` 循环依赖，**(3)** 悬挂引用（`fromId/toId` 不存在）。
- **REQ-E1-2** 规则码（固定枚举）
  - **AC**：返回 `ruleCode∈{DUP_REQID, CYCLE_DERIVE_REFINE, BROKEN_REF}`，示例：`{"ruleCode":"DUP_REQID","targetId":"R-12","message":"reqId duplicated: REQ-001"}`。
- **REQ-E1-3** 接口返回
  - **AC**：`POST /api/v1/validate/static {ids?:[]}` → `{violations:[{ruleCode,targetId,message,details?}]}`；**≤500 元素**处理 < **2s**。
- **REQ-E1-4** 前端呈现
  - **AC**：违规对象在视图中高亮；可导出 **JSON 报告**（CSV 导出为 **P1**）。

> Resolved/表达式求值 **P2**（MVP 不启用）。

---

## EPIC F｜依赖与交付（P0）

### Story F1｜离线构建与镜像

**As** DevOps **I want** 构建与运行不依赖外网 **so that** 可在内网/断网稳定交付。

**Requirements**

- **REQ-F1-1** Maven 镜像
  - **AC**：提供 `settings.offline.xml`，`<mirrorOf>*</mirrorOf>` 指向内网或 `file:` 仓库；`mvn -o -s settings.offline.xml verify` 成功。
- **REQ-F1-2** 供应链守门
  - **AC**：启用 `maven-enforcer` 禁止非白名单仓库；生成 SBOM，依赖仅指向内网域/`file:`。
