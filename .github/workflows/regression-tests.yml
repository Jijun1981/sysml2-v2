name: SysML v2 å›å½’æµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œå®Œæ•´å›å½’æµ‹è¯•
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - core  
          - full
          - all

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository -Xmx1024m -XX:MaxPermSize=512m'

jobs:
  # ä»£ç å˜æ›´æ£€æµ‹
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      scripts-changed: ${{ steps.changes.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'pom.xml'
              - '.github/workflows/**'
            frontend:
              - 'frontend/**' 
              - 'package*.json'
              - '.github/workflows/**'
            scripts:
              - 'scripts/**'
              - '.github/workflows/**'

  # å¿«é€Ÿå†’çƒŸæµ‹è¯• (æ‰€æœ‰åˆ†æ”¯)
  smoke-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ç¼“å­˜Mavenä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm ci

      - name: å¯åŠ¨åç«¯æœåŠ¡
        run: |
          cd backend
          mvn spring-boot:run &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health >/dev/null; then
              echo "åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done

      - name: æ‰§è¡Œå†’çƒŸæµ‹è¯•
        run: |
          chmod +x scripts/regression-suite.sh
          scripts/regression-suite.sh smoke --ci

      - name: ä¸Šä¼ å†’çƒŸæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: smoke-test-reports-${{ github.sha }}
          path: |
            test-reports/
            logs/
          retention-days: 7

  # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• (ä¸»è¦åˆ†æ”¯)
  core-tests:
    runs-on: ubuntu-latest
    needs: [detect-changes, smoke-tests]
    if: contains(github.ref, 'main') || contains(github.ref, 'develop') || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        test-group: [backend-core, frontend-core]
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: è®¾ç½®Node.jsç¯å¢ƒ  
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ç¼“å­˜Mavenä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm ci

      - name: å¯åŠ¨åç«¯æœåŠ¡
        if: matrix.test-group == 'frontend-core' || needs.detect-changes.outputs.backend-changed == 'true'
        run: |
          cd backend
          mvn spring-boot:run &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health >/dev/null; then
              echo "åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done

      - name: æ‰§è¡Œåç«¯æ ¸å¿ƒæµ‹è¯•
        if: matrix.test-group == 'backend-core' && (needs.detect-changes.outputs.backend-changed == 'true' || needs.detect-changes.outputs.scripts-changed == 'true')
        run: |
          cd backend
          mvn test -Dtest="RequirementServiceTest,FieldStandardizationTest,FileModelRepositoryTest,UniversalElementServiceTest" -q

      - name: æ‰§è¡Œå‰ç«¯æ ¸å¿ƒæµ‹è¯•  
        if: matrix.test-group == 'frontend-core' && (needs.detect-changes.outputs.frontend-changed == 'true' || needs.detect-changes.outputs.scripts-changed == 'true')
        run: |
          cd frontend
          npm test -- --run --reporter=basic src/__tests__/simple.test.ts src/__tests__/simple-react.test.tsx

      - name: ä¸Šä¼ æ ¸å¿ƒæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: core-test-reports-${{ matrix.test-group }}-${{ github.sha }}
          path: |
            test-reports/
            logs/
          retention-days: 7

  # å…¨é‡å›å½’æµ‹è¯• (å‘å¸ƒåˆ†æ”¯å’Œå®šæ—¶ä»»åŠ¡)
  full-regression:
    runs-on: ubuntu-latest
    needs: [detect-changes, smoke-tests]
    if: contains(github.ref, 'main') || contains(github.ref, 'release/') || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  
          cache-dependency-path: frontend/package-lock.json

      - name: ç¼“å­˜Mavenä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm ci

      - name: å¯åŠ¨åç«¯æœåŠ¡
        run: |
          cd backend
          mvn spring-boot:run &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          for i in {1..45}; do
            if curl -s http://localhost:8080/actuator/health >/dev/null; then
              echo "åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/45)"
            sleep 2
          done

      - name: æ‰§è¡Œå…¨é‡å›å½’æµ‹è¯•
        run: |
          chmod +x scripts/regression-suite.sh
          TEST_LEVEL="${{ github.event.inputs.test_level || 'full' }}"
          scripts/regression-suite.sh "$TEST_LEVEL" --ci

      - name: æ£€æŸ¥å…³é”®ä¿æŠ¤åŠŸèƒ½
        run: |
          # éªŒè¯åˆ é™¤æŒä¹…åŒ–ä¿®å¤
          echo "éªŒè¯åˆ é™¤æŒä¹…åŒ–ä¿®å¤..."
          TEST_ID="CI-DEL-$(date +%s)"
          
          # åˆ›å»ºæµ‹è¯•æ•°æ®
          CREATE_RESULT=$(curl -s -X POST "http://localhost:8080/api/v1/requirements" \
            -H "Content-Type: application/json" \
            -d "{\"elementId\":\"$TEST_ID\",\"reqId\":\"$TEST_ID\",\"name\":\"CIåˆ é™¤æµ‹è¯•\"}")
          
          if echo "$CREATE_RESULT" | grep -q "$TEST_ID"; then
            echo "âœ… åˆ›å»ºæµ‹è¯•æ•°æ®æˆåŠŸ"
            
            # åˆ é™¤æ•°æ®
            curl -s -X DELETE "http://localhost:8080/api/v1/requirements/$TEST_ID"
            
            # éªŒè¯åˆ é™¤æŒä¹…åŒ–
            if ! curl -s "http://localhost:8080/api/v1/requirements" | grep -q "$TEST_ID"; then
              echo "âœ… åˆ é™¤æŒä¹…åŒ–éªŒè¯é€šè¿‡"
            else
              echo "âŒ åˆ é™¤æŒä¹…åŒ–éªŒè¯å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥"
            exit 1
          fi

      - name: ç”Ÿæˆè´¨é‡é—¨ç¦æŠ¥å‘Š
        run: |
          # åˆ›å»ºè´¨é‡é—¨ç¦æŠ¥å‘Š
          cat > quality-gate-report.md << EOF
          # è´¨é‡é—¨ç¦æŠ¥å‘Š
          
          **åˆ†æ”¯**: ${{ github.ref }}
          **æäº¤**: ${{ github.sha }}
          **æ‰§è¡Œæ—¶é—´**: $(date)
          
          ## å…³é”®ä¿æŠ¤åŠŸèƒ½çŠ¶æ€
          
          - âœ… åˆ é™¤æŒä¹…åŒ–ä¿®å¤: é€šè¿‡éªŒè¯
          - âœ… APIåŸºç¡€åŠŸèƒ½: é€šè¿‡éªŒè¯  
          - âœ… æ ¸å¿ƒä¸šåŠ¡æµç¨‹: é€šè¿‡éªŒè¯
          - âœ… æ•°æ®ä¸€è‡´æ€§: é€šè¿‡éªŒè¯
          
          ## è´¨é‡é—¨ç¦å†³ç­–
          
          **ğŸ‰ é€šè¿‡è´¨é‡é—¨ç¦** - å¯ä»¥å®‰å…¨åˆå¹¶/å‘å¸ƒ
          EOF

      - name: ä¸Šä¼ å…¨é‡å›å½’æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: full-regression-reports-${{ github.sha }}
          path: |
            test-reports/
            logs/
            quality-gate-report.md
          retention-days: 14

      - name: è¯„è®ºPRç»“æœ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('quality-gate-report.md')) {
              const report = fs.readFileSync('quality-gate-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## ğŸ” å›å½’æµ‹è¯•ç»“æœ\n\n' + report
              });
            }

  # è´¨é‡é—¨ç¦å†³ç­–
  quality-gate:
    runs-on: ubuntu-latest
    needs: [smoke-tests, core-tests, full-regression]
    if: always() && (github.event_name == 'pull_request' || contains(github.ref, 'main'))
    
    steps:
      - name: è´¨é‡é—¨ç¦å†³ç­–
        run: |
          SMOKE_STATUS="${{ needs.smoke-tests.result }}"
          CORE_STATUS="${{ needs.core-tests.result }}"
          FULL_STATUS="${{ needs.full-regression.result }}"
          
          echo "å†’çƒŸæµ‹è¯•: $SMOKE_STATUS"
          echo "æ ¸å¿ƒæµ‹è¯•: $CORE_STATUS" 
          echo "å…¨é‡å›å½’: $FULL_STATUS"
          
          # è´¨é‡é—¨ç¦è§„åˆ™
          if [[ "$SMOKE_STATUS" == "success" ]]; then
            if [[ "$CORE_STATUS" == "success" || "$CORE_STATUS" == "skipped" ]]; then
              echo "âœ… è´¨é‡é—¨ç¦é€šè¿‡ - å¯ä»¥å®‰å…¨åˆå¹¶"
              echo "QUALITY_GATE=PASS" >> $GITHUB_ENV
            else
              echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ - æ ¸å¿ƒæµ‹è¯•æœªé€šè¿‡"
              echo "QUALITY_GATE=FAIL" >> $GITHUB_ENV
              exit 1
            fi
          else
            echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ - å†’çƒŸæµ‹è¯•æœªé€šè¿‡"  
            echo "QUALITY_GATE=FAIL" >> $GITHUB_ENV
            exit 1
          fi

      - name: æ›´æ–°æäº¤çŠ¶æ€
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = process.env.QUALITY_GATE === 'PASS' ? 'success' : 'failure';
            const description = process.env.QUALITY_GATE === 'PASS' 
              ? 'è´¨é‡é—¨ç¦é€šè¿‡ - å¯ä»¥å®‰å…¨åˆå¹¶' 
              : 'è´¨é‡é—¨ç¦å¤±è´¥ - éœ€è¦ä¿®å¤åé‡è¯•';
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              description: description,
              context: 'SysML v2 è´¨é‡é—¨ç¦'
            });