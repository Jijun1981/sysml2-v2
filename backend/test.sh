#!/bin/bash
# SysML MVP å›žå½’æµ‹è¯•å¥—ä»¶

echo "================================================"
echo "ðŸ§ª SysML MVP å›žå½’æµ‹è¯•å¥—ä»¶"
echo "================================================"
echo ""

# é€‰æ‹©æµ‹è¯•çº§åˆ«
echo "è¯·é€‰æ‹©æµ‹è¯•çº§åˆ«ï¼š"
echo "1) å¿«é€Ÿæµ‹è¯• - Controllerå±‚ï¼ˆ2åˆ†é’Ÿï¼‰"
echo "2) æ ‡å‡†æµ‹è¯• - æ‰€æœ‰å•å…ƒæµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼‰"
echo "3) å®Œæ•´æµ‹è¯• - æ¸…ç†ç¼–è¯‘+å…¨æµ‹è¯•ï¼ˆ10åˆ†é’Ÿï¼‰"
echo -n "é€‰æ‹© (1-3ï¼Œé»˜è®¤2): "
read -t 10 choice
choice=${choice:-2}

case $choice in
    1)
        echo "ðŸš€ æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
        mvn test -Dtest="*ControllerTest" --batch-mode --quiet
        ;;
    2)
        echo "ðŸ“Š æ‰§è¡Œæ ‡å‡†æµ‹è¯•..."
        mvn test --batch-mode
        ;;
    3)
        echo "ðŸ”§ æ‰§è¡Œå®Œæ•´æµ‹è¯•ï¼ˆåŒ…å«æ¸…ç†å’Œç¼–è¯‘ï¼‰..."
        mvn clean test
        ;;
    *)
        echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œæ‰§è¡Œæ ‡å‡†æµ‹è¯•..."
        mvn test --batch-mode
        ;;
esac

# æ£€æŸ¥æµ‹è¯•ç»“æžœ
if [ $? -eq 0 ]; then
    echo ""
    echo "================================================"
    echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä»£ç è´¨é‡OKï¼Œå¯ä»¥å®‰å…¨æäº¤ã€‚"
    echo "================================================"
    
    # æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡
    echo ""
    echo "ðŸ“ˆ æµ‹è¯•ç»Ÿè®¡ï¼š"
    grep -h "Tests run:" target/surefire-reports/*.txt 2>/dev/null | tail -5
    
else
    echo ""
    echo "================================================"
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼è¯·ä¿®å¤é—®é¢˜åŽå†æäº¤ã€‚"
    echo "================================================"
    
    # æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•
    echo ""
    echo "å¤±è´¥çš„æµ‹è¯•ï¼š"
    grep -l "FAILURE" target/surefire-reports/*.txt 2>/dev/null | xargs basename -s .txt
    
    exit 1
fi